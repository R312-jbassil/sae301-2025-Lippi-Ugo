---
import Layout from "../layouts/LayoutWithoutHeader.astro";
import Logo from "../assets/TaVueLogo.svg";
---

<Layout title="TaVue - Connexion / Inscription">
	<div class="min-h-screen flex items-center justify-center bg-base-100">
	<div class="absolute top-10 left-10 w-96 h-96 bg-[#A4F4CF] opacity-50 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 right-0 w-[28rem] h-[28rem] bg-[#A4F4CF] opacity-70 rounded-full blur-3xl"></div>
    <div class="card bg-secondary shadow-xl w-full max-w-sm p-8">
      <div class="flex justify-center mb-4">
		<Logo class="w-20 h-20" />
	  </div>
      <h2 class="text-center text-lg font-medium mb-1">Bienvenue</h2>
      <p class="text-center text-sm mb-6 text-secondary-content">
        Créez vos lunettes éco-responsables
      </p>

      <!-- Onglets -->
      <div class="flex justify-center mb-6 bg-accent rounded-full p-1">
        <button
          id="tab-login"
          class="btn btn-sm rounded-full w-40 bg-base-100"
        >
          Connexion
        </button>
        <button
          id="tab-register"
          class="btn btn-sm rounded-full w-36 ml-2 bg-accent"
        >
          Inscription
        </button>
      </div>

      <!-- Connexion -->
      <form id="login-form" class="space-y-4">
        <label class="form-control">
          <span class="label-text">Email</span>
          <input
            id="login-email"
            type="email"
            placeholder="votre@email.fr"
            class="input input-bordered w-full"
            required
          />
        </label>

        <label class="form-control">
          <span class="label-text">Mot de passe</span>
          <input
            id="login-password"
            type="password"
            placeholder="********"
            class="input input-bordered w-full"
            required
          />
        </label>

        <div class="flex items-center justify-between text-sm pt-3">
          <label class="flex items-center gap-2">
            <input id="login-remember" type="checkbox" class="checkbox checkbox-sm" />
            <span>Se souvenir de moi</span>
          </label>
          <a href="#" class="link link-hover">Mot de passe oublié ?</a>
        </div>

        <button type="submit" class="btn w-full bg-primary text-neutral-content hover:bg-neutral">
          Se connecter
        </button>

        <p id="login-msg" class="text-sm text-red-500 mt-2"></p>

        <div class="divider text-xs text-gray-400">OU CONTINUER AVEC</div>

        <div class="grid gap-2">
          <button id="google-login" type="button" class="btn w-full bg-base-100 border border-gray-200 flex items-center gap-2">
            <img
              src="https://www.svgrepo.com/show/475656/google-color.svg"
              alt="Google"
              class="w-5 h-5"
            />
            <span>Se connecter avec Google</span>
          </button>
        </div>
      </form>

      <!-- Inscription -->
      <form id="register-form" class="space-y-4 hidden">
        <div class="flex gap-2">
          <label class="form-control w-1/2">
            <span class="label-text">Prénom</span>
            <input
              id="register-first"
              type="text"
              placeholder="Jean"
              class="input input-bordered w-full"
            />
          </label>
          <label class="form-control w-1/2">
            <span class="label-text">Nom</span>
            <input
              id="register-last"
              type="text"
              placeholder="Dupont"
              class="input input-bordered w-full"
            />
          </label>
        </div>

        <label class="form-control">
          <span class="label-text">Email</span>
          <input
            name="email"
            id="register-email"
            type="email"
            placeholder="votre@email.fr"
            class="input input-bordered w-full"
            required
          />
        </label>

        <label class="form-control">
          <span class="label-text">Mot de passe</span>
          <input
            name="password"
            id="register-password"
            type="password"
            placeholder="********"
            class="input input-bordered w-full"
            required
          />
        </label>

        <label class="form-control">
          <span class="label-text">Confirmer le mot de passe</span>
          <input
            name="passwordConfirm"
            id="register-password-confirm"
            type="password"
            placeholder="********"
            class="input input-bordered w-full"
            required
          />
        </label>

        <label class="flex items-center gap-2 text-sm pt-3">
          <input id="register-terms" type="checkbox" class="checkbox checkbox-sm" />
          <span>J’accepte les conditions d’utilisation et la politique de confidentialité</span>
        </label>

        <button type="submit" class="btn w-full bg-primary text-neutral-content hover:bg-neutral">
          Créer mon compte
        </button>

        <p id="register-msg" class="text-sm text-red-500 mt-2"></p>

        <div class="divider text-xs text-gray-400">OU CONTINUER AVEC</div>

        <button class="btn w-full bg-base-100 border border-gray-200">
          <img
            src="https://www.svgrepo.com/show/475656/google-color.svg"
            alt="Google"
            class="w-5 h-5"
          />
          <span>Se connecter avec Google</span>
        </button>
      </form>

      <p class="text-center text-xs text-primary mt-6">
    	Fabrication française • Éco-responsable
      </p>
    </div>
  </div>

  <!-- Script: tabs + auth handlers (server-side via endpoints using src/utils/pb.ts) -->
  <script>
    // @ts-nocheck
    // Elements
    const tabLogin = document.getElementById("tab-login");
    const tabRegister = document.getElementById("tab-register");
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    const loginMsgEl = document.getElementById('login-msg');
    const registerMsgEl = document.getElementById('register-msg');

    // Tabs
    if (tabLogin && tabRegister && loginForm && registerForm) {
      tabLogin.addEventListener("click", () => {
        tabLogin.classList.add("bg-base-100");
        tabRegister.classList.remove("bg-base-100");
        tabRegister.classList.add("bg-accent");

        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      });

      tabRegister.addEventListener("click", () => {
        tabRegister.classList.add("bg-base-100");
        tabLogin.classList.remove("bg-base-100");
        tabLogin.classList.add("bg-accent");

        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      });
    }

    // Helper to show server error details when available
    const showError = (el, payload) => {
      if (!el) return;
      try {
        if (!payload) { el.textContent = 'Erreur inconnue'; return; }
        if (typeof payload === 'string') { el.textContent = payload; return; }
        if (payload?.error) {
          // PocketBase often returns structured error objects
          if (typeof payload.error === 'string') return void (el.textContent = payload.error);
          if (payload.error?.message) return void (el.textContent = payload.error.message);
          // If validation details object
          if (typeof payload.error === 'object') return void (el.textContent = Object.entries(payload.error).map(([k,v]) => `${k}: ${Array.isArray(v)?v.join(', '):JSON.stringify(v)}`).join(' — '));
        }
        el.textContent = JSON.stringify(payload);
      } catch (e) {
        el.textContent = 'Erreur lors de l\'analyse du message d\'erreur';
      }
    };

    // Login -> POST to server endpoint
    if (loginForm) {
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (loginMsgEl) loginMsgEl.textContent = '';
  const email = document.getElementById('login-email')?.['value']?.trim();
  const password = document.getElementById('login-password')?.['value'];
        if (!email || !password) {
          if (loginMsgEl) loginMsgEl.textContent = 'Email et mot de passe requis.';
          return;
        }

        try {
          const resp = await fetch('/js/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          const data = await resp.json().catch(() => null);
          if (!resp.ok) {
            showError(loginMsgEl, data ?? (await resp.text()));
            return;
          }

          // Store token in localStorage so client can use it for subsequent requests if needed
          if (data?.token) localStorage.setItem('pb_auth', data.token);
          // Redirect to configurator on success
          window.location.href = '/configurateur';
        } catch (err) {
          console.error('Network/login error:', err);
          if (loginMsgEl) loginMsgEl.textContent = 'Erreur réseau lors de la connexion: ' + (err?.message || String(err));
        }
      });
    }

    // Registration -> POST to server endpoint
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (registerMsgEl) registerMsgEl.textContent = '';

  const first = document.getElementById('register-first')?.['value'] || '';
  const last = document.getElementById('register-last')?.['value'] || '';
  const email = document.getElementById('register-email')?.['value']?.trim();
  const password = document.getElementById('register-password')?.['value'];
  const passwordConfirm = document.getElementById('register-password-confirm')?.['value'];

        if (!email || !password || !passwordConfirm) {
          if (registerMsgEl) registerMsgEl.textContent = 'Veuillez remplir tous les champs requis.';
          return;
        }

        try {
          const resp = await fetch('/js/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ first, last, email, password, passwordConfirm })
          });

          const data = await resp.json().catch(() => null);
          if (!resp.ok) {
            showError(registerMsgEl, data ?? (await resp.text()));
            return;
          }

          if (registerMsgEl) registerMsgEl.textContent = 'Inscription réussie, vérifiez votre email';
        } catch (err) {
          console.error('Network/register error:', err);
          if (registerMsgEl) registerMsgEl.textContent = 'Erreur réseau lors de l\'inscription: ' + (err?.message || String(err));
        }
      });
    }

    // OAuth / Google button: fallback message (requires server-side OAuth wiring)
    const googleBtn = document.getElementById('google-login');
    if (googleBtn) {
      googleBtn.addEventListener('click', () => {
        if (loginMsgEl) loginMsgEl.textContent = 'Connexion OAuth non configurée côté client. Utilisez le flux serveur.';
      });
    }
  </script>
</Layout>

